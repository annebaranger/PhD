---
title: "Sampling"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(flexdashboard)
library(rgdal)
library(raster)
library(leaflet)
library(starmie)
library(rstan)
library(bayesplot)
library(abind)
library(ggrepel)
library(tidyverse)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
    cache = T, cache.lazy = F)
```

# General

##

### To Do

1. Material command:
    + $\sim 10$ Sac de lancer Libre 250g
    + $2-4$ Fil de lancer shaoLINE Teufelberger 60m
    + $\sim 2$ Ã‰lastique BIG SHOT
    + $\sim 6$ Gants fins ?
    + $\sim 4$ casques ?
1. Sampling design
    + Plots: Control & Biodiversity ?
    + Individuals: 400-500 ?
    + Traits
        * Leaf (SLA, LDMC, LT, LA, SPAD) 
        * Branch (BrWD, BrBD, BrBT)
        * Trunk (WD, BT) ?
        * Anatomy ?
        * Physiology ?
1. FTH module design
    + Pre-sampling
    + Plots
    + Question / Hypothesis / Analysis

### Docs

##

### Planning

1. 31.07-03.08 Material command
1. 21.09-14.09 pre-FTH field (2-3 days)
1. 17.09-21.09 FTH field work (4-5 days)
1. 24.09-28.09 FTH analysis and defense
1. 03.08-05.08 post-CEBA field work w Myriam (2-3 days)
1. +2-4 weeks of field sampling (depending on individuals objective)

### Maps

# Samples

# Maps

### Dynamic map of selected individuals

```{r selected, eval=F}
sel_pal <-colorBin(c('transparent', 'black'), trees$sel)
leaflet() %>%
  addPolygons(data = limits, fillOpacity = 0,
              opacity = 0.5, col = 'black') %>% 
  addCircles(data = treesXY, col = 'black', fillOpacity = 1,
             fillCol = sel_pal(trees$sel), radius= ~circonf/25,
             label = ~as.character(n_arbre)) %>% 
  addLegend(colors = c('transparent', 'black'), 
            labels = c('not selected', 'selected'),
            title = 'Sampling')
```

```{r maps functions, eval=F}
rotateProj = function(spobj, angle) {
    boxpts = SpatialPoints(t(bbox(spobj)), proj4string = CRS(proj4string(spobj)))
    boxLL = bbox(spTransform(boxpts, CRS("+init=epsg:4326")))
    llc = apply(boxLL, 1, mean)
    prj = paste0("+proj=omerc +lat_0=", llc[2], " +lonc=", llc[1], " +alpha=", 
        angle, " +gamma=0.0 +k=1.000000 +x_0=0.000 +y_0=0.000 +ellps=WGS84 +units=m ")
    CRS(prj)
}
find_angle <- function(spobj){
  spobj <- subset(spobj, Subplot == unique(spobj$Subplot)[1])
  spobj <- fortify(spobj) %>% 
    filter(long == min(long) | lat == min(lat)) %>% 
    select(long, lat) %>% 
    distinct()
  row.names(spobj) <- c('A', 'B')
  spobj['C',] <- apply(spobj, 2, min)
  Pab <- sqrt(sum(apply(spobj[c('A', 'B'),], 2, diff)^2))
  Pac <- sqrt(sum(apply(spobj[c('A', 'C'),], 2, diff)^2))
  Pbc <- sqrt(sum(apply(spobj[c('B', 'C'),], 2, diff)^2))
  angle <- acos((Pab^2 + Pac^2 - Pbc^2) / (2 * Pab * Pac))
  angle <- angle*180/pi
  angles <- c(angle, angle-90)
  angle <- angles[which(sapply(c(angle, angle-90), abs) == min(sapply(c(angle, angle-90), abs)))]
  return(angle)
}
make_map <- function(limits, treesXY, contour, p){
  limits_plot <-  subset(limits, Plot == p)
  if(p != 16)
    limits_plot <-  subset(limits_plot, TypeSub == "Subplots")
  else
    limits_plot <-  subset(limits_plot, TypeSub == "SubplotsP16")
  newProj <- rotateProj(limits_plot, find_angle(limits_plot))
  limits_plot <- spTransform(limits_plot, newProj)
  treesXY_plot <- subset(treesXY, n_parcelle == p)
  treesXY_plot <- spTransform(treesXY_plot, newProj)
  contour_plot <- spTransform(contour, newProj)
  contour_plot <- crop(contour_plot, extent(limits_plot))
  g <- ggplot() +
    geom_polygon(data = fortify(limits_plot),
                 aes(long, lat, group=group),
                 fill = "transparent", colour = "black", alpha = 0.2) +
    geom_polygon(data = fortify(contour_plot),
                 aes(long, lat, group=group),
                 colour = "grey", alpha = 0) +
    geom_point(data = as.data.frame(treesXY_plot),
               aes(x = Xutm, y = Yutm, size=circonf/pi*100,
                   col = sel)) +
    geom_text_repel(data = as.data.frame(treesXY_plot),
                    aes(Xutm, Yutm, 
                        label = n_arbre)) +
    ggtitle(paste('Parcelle', p)) +
    coord_equal() +
    theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank()) +
    scale_color_continuous(palette = colorBin( c('lightgrey', 'black'), domain = c(0,1))) +
    ggsn::north(fortify(limits_plot), symbol = 12, 
                scale = 0.05, anchor = c(x= 125, y = 140))
  return(g)
}
```

```{r maps, eval=F}
maps <- sapply(sort(unique(trees$n_parcelle)), 
               function(x) make_map(limits, treesXY, contour, x),
               simplify = F)
names(maps) <- paste0('P', sort(unique(trees$n_parcelle)))
# lapply(maps, function(x)
#   ggsave(x, file = paste0(gsub(' ', '', x$labels$title), '.png'),
#          path = './symphonia_save/maps/',
#          width = 297, height = 420, unit = 'mm',
#          dpi = 300))
```

```{r table, eval=F}
# trees_sel <- trees %>% 
#   filter(sel == 1) %>% 
#   arrange(n_parcelle, n_carre, n_arbre)
# write.csv(trees_sel, "./symphonia_save/trees_sel.csv",
#           row.names = F)
```

