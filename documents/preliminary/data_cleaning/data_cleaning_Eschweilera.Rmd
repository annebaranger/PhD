---
title: "Eschweilera data cleaning"
date: '`r Sys.Date()`'
author: Anne Baranger & Sylvain Schmitt
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(tidyverse)
library(stringdist)
library(googlesheets)
library(knitr)
library(kableExtra)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 6,
  cache = T, cache.lazy = F)
path <- "~/Documents/BIOGECO/PhD/data/Eschweilera_Paracou/Measures/"
```

# Introduction

# Individuals

## First correction

The idea is to transform FTH data to the general formatting, i.e. :

* Date (YYYY/MM/DD)
* Time (HHHMM)
* Plot
* SubPlot
* FieldTreeNum
* Dawkins
* Position
* TrunkForm
* BarkColor
* BarkRuggedness
* BarkAspect
* Lenticels
* BladeForm
* LeafConsistency
* LeafSurface
* LeafBase
* LeafMargin
* HyperAcuminated
* BentPrincpalN


```{r ind, echo=T}
indFTH <- read_delim(file.path(path, "data_FTH.csv"), delim = ",") %>% 
  rename(TrunkForm = `Trunk form`, BarkColor = `Bark color`, BarkRuggedness = `Bark ruggedness`, 
         BarkAspect = `Bark aspect`, BladeForm = `Blade form`, 
         LeafConsistency = `Leaf consistency`, LeafSurface = `Leaf surface`, 
         LeafBase = `Leaf base`, LeafMargin = `Leaf margin`,
         HyperAcuminated = `Longue pointe`, BentPrincipalN = `Pli sur nervure principale`) %>% 
  separate(Date, c("Month", "Day", "Year"), "/") %>% # Date
  mutate(Date = paste0(Year, "/0", Month, "/", Day)) %>% 
  select(-Year, -Month, -Day) %>% 
  mutate(Time = gsub(":", "H", substr(as.character(Time), 1, 5))) %>% # Time
  mutate(Dawkins = toupper(Dawkins)) %>% # Dawkins
  mutate(Position = recode_factor(Position, bas = "LOW", haut = "TOP", milieu = "MID",
                                  `milieu lumière` = "MID/LIGHT", `milieu/haut` = "MID",
                                  `bas lumière` = "LOW/LIGHT", `haut lumière` = "TOPLIGHT",
                                  `bas/lumière` = "LOW/LIGHT", `milieu/bas` = "MID")) %>% # Position
  mutate(TrunkForm = recode_factor(TrunkForm, `B--` = "B-", `B (petits)` = "B-", `B+` = "B",
                                  BS = "B/S", tordu = "N", C = "B")) %>% # TrunkForm
  mutate(BarkColor = recode_factor(BarkColor, `B/BR` = "B/RB", BG = "B/G", D = "DB",
                                   `DB+` = "DB", `DB/B` = "B/DB", GB = "B/G")) %>% # BarkColor
  mutate(BarkAspect = recode_factor(BarkAspect, `?` = "N", `F+` = "F", `F/D` = "D/F",
                                    `F/D-` = "D-/F", `F-HM` = "F-/HM", `F/HM+` = "F/HM",
                                    `F+/HM` = "F/HM", `F/S/HM` = "F/HM/S", 
                                    `HM/D (?)` = "D/HM", `HM/F` = "F/HM",
                                    `S+/D` = "D/S+", `S/F/HM`	= "F/HM/S", `S-/HM`	= "HM/S-",
                                    `S/HM`	= "HM/S", `R/HM` = "F/HM")) %>% # BarkAspect
  mutate(Lenticels = recode_factor(Lenticels, N = "A", `P+` = "P", `P-` = "P")) %>% # Lenticels
  mutate(BladeForm = recode_factor(BladeForm, `E+` = "E", `Oblan/E` = "E/Oblan")) %>% # BladeForm
  mutate(LeafConsistency = recode_factor(LeafConsistency, `Char -` = "Char-", 
                                         `Char+` = "Char")) %>% # LeafConsistency
  mutate(LeafBase = recode_factor(LeafBase, `O/A` = "A/O", `O-R` = "O/R", `R/A` = "A/R",
                                  RO = "O/R", `R/O` = "O/R")) %>% # LeafBase
  mutate(LeafMargin = recode_factor(LeafMargin, `E/C-` = "C-/E")) %>% # LeafMargin
  select(Date, Time, Plot, SubPlot, FieldTreeNum, Dawkins, Position,
         TrunkForm, BarkColor, BarkRuggedness, BarkAspect, Lenticels,
         BladeForm, LeafConsistency, LeafSurface, LeafBase, LeafMargin,
         HyperAcuminated, BentPrincipalN, Comment) %>% 
  unique()
# read_delim(file.path(path, "Indviduals.csv"), delim = ",", col_types = cols(Date = col_character())) %>% 
#   bind_rows(indFTH) %>% 
#   write_delim(file.path(path, "Indviduals_all.csv"), delim = ",")
```

## Individuals to add

* P13-1-1
* P13-1-816
* P13-1-991

# Fresh measurements

## Join files

Fresh measurements have three different format of files :

1. the FTH file (*data_FTH.csv*) mixing individual data and fresh measurement which might be differently encoded
1. Tom file (*sylvainESCHWEILERA.csv*) mixing individual data and fresh measurement with some errors:
1. All others files (*2018...ods*), except the november ones which are still FTH files, in the correct format which might integrate typo issues

Consequently for the ODS files we will only use those collected in October with pattern 2018.10.*.ods .

```{bash, eval=F, echo=T}
cd ~/Documents/BIOGECO/PhD/data/Eschweilera_Paracou/Measures
mkdir csv
for file in ./2018.10.*.ods
do
  echo $file
  filename=$(basename "$file")
  filename="${filename%.*}"
  ssconvert -S --export-type=Gnumeric_stf:stf_csv "${filename}".ods ./csv/"${filename}".csv
done
```


```{r FreshMeasurements, eval=F, echo=T}
FTH <- read_delim(file.path(path, "data_FTH.csv"), delim = ",") %>% 
  rename(Leaf = Numero_feuille, FreshWeight = Fresh_Weight, SPAD1 = `SPAD 1`) %>% 
  select(IdGenetic, Plot, SubPlot, FieldTreeNum, Leaf, 
         SPAD1, SPAD2, SPAD3, FreshWeight, LT1, LT2, LT3) %>% 
  mutate_at(vars(starts_with("SPAD")),as.numeric) %>% 
  mutate_at(vars(starts_with("LT")),as.numeric) %>% 
  mutate(Leaf = as.numeric(Leaf))
Tom <- read_delim(file.path(path, "sylvainESCHWEILERA.csv"), delim = ",") %>% 
  rename(IdGenetic = IdGentic) %>% 
  fill(IdGenetic, Plot, SubPlot, FieldTreeNum) %>% 
  mutate(Plot = as.numeric(gsub('([[:alpha:]])', "", Plot)))
All <- sapply(list.files(file.path(path, "csv"), full.names = T), function(file)
  read.csv(file, dec = ","), simplify = F) %>% 
  bind_rows() %>% 
  select(IdGenetic, Plot, SubPlot, FieldTreeNum, Leaf, 
         SPAD1, SPAD2, SPAD3, FreshWeight, LT1, LT2, LT3) %>% 
  mutate(IdGenetic = ifelse(IdGenetic == "", NA, IdGenetic)) %>% 
  filter(!is.na(Leaf)) %>% 
  fill(IdGenetic, Plot, SubPlot, FieldTreeNum)
bind_rows(All, Tom, FTH) %>% 
  write_delim(file.path(path, "LeafFresh_all.csv"), delim = ",")
```

## Individuals

Now we need to check and correct individual codes. 

```{r FreshIndData}
individuals <- googlesheets::gs_title("Measures_Eschweilera") %>% 
  googlesheets::gs_read("Individuals") %>% 
  dplyr::select(-X1) %>% 
  mutate(CodeParacou = paste0("P", Plot, "-", SubPlot, "-", TreeFieldNum)) 
fresh <- googlesheets::gs_title("Measures_Eschweilera") %>% 
  googlesheets::gs_read("LeafFresh") %>% 
  dplyr::select(-X1) %>% 
  mutate(CodeParacou = paste0("P", Plot, "-", SubPlot, "-", TreeFieldNum))
```


First of all there 3 more individuals in fresh measurements compared to the individual dataset that have not be entered as data. To locate theim we need first to correct other mispelled code.

```{r IndCount, echo=T}
length(unique(individuals$CodeParacou))
length(unique(fresh$CodeParacou))
```


```{r FreshInd}
ref <- setdiff(individuals$CodeParacou, fresh$CodeParacou)
cor <- setdiff(fresh$CodeParacou, individuals$CodeParacou)
data.frame(FreshID = cor,
           Suggestion = ref[stringdist::amatch(cor, ref, maxDist = Inf)]) %>% 
  group_by(Suggestion) %>% 
  mutate(TimeSuggested = n()) %>% 
  mutate(TimeSuggested = cell_spec(TimeSuggested, bold = ifelse(TimeSuggested > 1, T, F))) %>% 
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
```

# Leaf Area

This part is currently developped by Anne.

## Leaf attribution

```{r Aattribution, eval=F}
LA <- LA %>% 
  separate(Label, c("Plot", "SubPlot", "FieldTreeNum"), 
           "-", convert = T) %>% 
  mutate(Plot = as.numeric(gsub("P", "", Plot))) %>% 
  mutate(FieldTreeNum0 = FieldTreeNum) %>% 
  mutate(FieldTreeNum = as.numeric(gsub('([[:alpha:]])', "", FieldTreeNum0))) %>% 
  mutate(Scan = gsub('[0-9]+', "", FieldTreeNum0)) %>% 
  select(-FieldTreeNum0) %>% 
  arrange(Plot, SubPlot, FieldTreeNum, Area_exclude) %>% 
  group_by(Plot, SubPlot, FieldTreeNum) %>% 
  mutate(Leaf_order = (1:6)[1:n()])
data <- data %>% 
  arrange(Plot, SubPlot, FieldTreeNum, Fresh_Weight) %>% 
  group_by(Plot, SubPlot, FieldTreeNum) %>% 
  mutate(Leaf_order = (1:6)[1:n()])
data <- data %>% 
  left_join(LA)
# data %>% 
#   write_csv("./data.csv")
```

