---
title: "A01: Symphonia distribution"
date: '`r Sys.Date()`'
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
  bookdown::word_document2: default
  github_document: default
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(parallel)
library(tidyverse)
library(ggfortify)
library(raster)
library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 6,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "~/Documents/BIOGECO/PhD/data/Paracou/"
crs <- '+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0' # global crs definition
```

```{r trees}
trees <- src_sqlite(file.path(path, "trees/Paracou.sqlite")) %>% 
  tbl("Paracou") %>% 
  filter(CensusYear == 2015) %>%
  filter(Species != "Indet.") %>% 
  collect() %>% 
  mutate(DBH = CircCorr*pi)
```

```{r env}
# env <- trees %>%
#   dplyr::select(idTree, Xutm, Yutm) %>%
#   unique()
# coordinates(env) <- ~Xutm + Yutm
# proj4string(env) <- '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
# env <- spTransform(env, CRSobj = crs)
# topo <- stack(
#   raster(file.path(path, "topography", "DEM_1m_2015.tif")),
#   raster(file.path(path, "topography", "RelativeElevation_1m.tif")),
#   raster(file.path(path, "topography", "slope_1m.tif")),
#   raster(file.path(path, "topography", "curvature_1m.tif")),
#   raster(file.path(path, "topography", "TRI_1m.tif")),
#   raster(file.path(path, "topography", "TWI_1m.tif"))
# )
# names(topo) <- c("DEM", "RelativeElevation", "Slope", "Curvature", "TRI", "TWI")
# topo <- projectRaster(topo, crs = crs)
# env <- data.frame(cbind(env@data, raster::extract(topo, env)))
# rm(topo)
# save(env, file = "./distribution_save/env.Rdata")
load("./distribution_save/env.Rdata")
```

```{r data}
data <- trees %>% 
  left_join(env)
```

# Introduction

The aim of this document is to study *Symphonia globulifera* distribution for both morphotype, *S. globumlifera* and *S. sp1*, with a bayseian approach including both biotic and abiotic environment and maybe the DBH.

```{r Allie, fig.cap = "Environmental variables selected in Allie et al 2015, PlosOne including intraspecific variability."}
data %>% 
  filter(Genus %in% c("Symphonia", "Eschweilera")) %>% 
  ggplot(aes(RelativeElevation, Slope, 
             col = Species, size = DBH)) +
  geom_point(alpha = 0.2) +
  facet_wrap(~Genus)
```

# Graphical exploration

## Abiotic variable


> We selected less correlated variable: DEM, TWI, and slope.

```{r densityAbiot,fig.cap="Abiotic variable density plot"}
data %>% 
  filter(Genus %in% c("Symphonia", "Eschweilera")) %>% 
  dplyr::select(Genus, Species, DEM, RelativeElevation, 
                Slope, Curvature, TRI, TWI) %>% 
  reshape2::melt(id.var = c("Genus", "Species")) %>% 
  group_by(variable) %>% 
  mutate(value = scale(value)) %>% 
  ungroup() %>% 
  ggplot(aes(value, fill = Species, col = Species)) + 
  geom_density(alpha = 0.3) +
  facet_grid(variable ~ Genus, scales = "free")
```

```{r pcaABiot, fig.cap="Abiotic variable PCA"}
autoplot(princomp(~ DEM + RelativeElevation + Slope + Curvature + TRI + TWI, 
                    data = filter(data, Genus %in% c("Symphonia", "Eschweilera")), cor = T),
         data = filter(data, Genus %in% c("Symphonia", "Eschweilera")),
         colour = "Species", alpha = 0.1, size = "DBH",
         loadings.label.size = 6,
         loadings.label.colour = 'black', loadings.label.vjust = 1.1,
         loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1)) +
  scale_color_discrete(guide= "none") +
  facet_wrap(~ Genus)
```


## Biotic variable

# Bayesian analysis

```{r dataReduction}
# data <- filter(data, Plot == 16) # for tests
# data <- filter(data, Genus == "Symphonia")
```

## Abiotic variable

For each morphotype we will consider tree belonging to all other species as an absence.

$$Presence_{morphotype} \sim \mathcal{B} (\theta_{morphotype}) $$
$$\theta_{morphotype} = logit[ \beta_{{DEM}_{morphotype}}*DEM +  \beta_{{TWI}_{morphotype}}*TWI +  \beta_{{Slope}_{morphotype}}*Slope]$$
$$ logit(x) = log(\frac{x}{1-x})$$ 

```{stan Mabiotic, output.var="Mabiotic", echo=T, eval=F}
  data {
    int N ; // # obs
    int<lower=0, upper=1> Presence[N] ;
    real DEM[N] ;
    real TWI[N] ;
    real Slope[N] ;
  }
  parameters {
    real beta_DEM ;
    real beta_TWI ;
    real beta_Slope ;
  }
  model {
    for(n in 1:N)
      Presence[n] ~ bernoulli_logit(beta_DEM*DEM[n] + beta_TWI*TWI[n] + beta_Slope*Slope[n]) ;
  }
  generated quantities {
    real Theta_pred[N] ;
    for(n in 1:N)
      Theta_pred[n] = beta_DEM*DEM[n] + beta_TWI*TWI[n] + beta_Slope*Slope[n] ;
  }
```

```{r fitMabiotic}
# fitGlobu <- sampling(Mabiotic, chains = 2,
#                      data = list(N = nrow(data),
#                                  Presence = as.numeric(data$Species == "globulifera"),
#                                  DEM = data$DEM,
#                                  TWI = data$TWI,
#                                  Slope = data$Slope))
# fitSp1 <- sampling(Mabiotic, chains = 2,
#                      data = list(N = nrow(data),
#                                  Presence = as.numeric(data$Species == "sp.1"),
#                                  DEM = data$DEM,
#                                  TWI = data$TWI,
#                                  Slope = data$Slope))
# save(fitGlobu, fitSp1, file = "./distribution_save/Mabiotic.Rdata")
load("./distribution_save/Mabiotic.Rdata")
pars <- c("beta_DEM", "beta_TWI", "beta_Slope")
broom::tidyMCMC(fitGlobu, pars = c(pars, "lp__"), droppars = NULL, rhat = T) %>%
  mutate(Species = "S. globulifera") %>% 
  bind_rows(broom::tidyMCMC(fitSp1, pars = c(pars, "lp__"), droppars = NULL, rhat = T) %>%
              mutate(Species = "S. sp1")) %>% 
  kable(caption = "Summary table of the model abiotic only")
```

```{r Cabiotic, fig.cap="Model parameters posterior for model abiotic only."}
cowplot::plot_grid(mcmc_intervals(as.array(fitGlobu), pars = pars), 
                   mcmc_intervals(as.array(fitSp1), pars = pars),
                   labels = c("S. globulifera", "S. sp1"), nrow = 2)
```

```{r Tabiotic, fig.cap="Markov chains trace plot after warmup for model abiotic only"}
cowplot::plot_grid(mcmc_trace(as.array(fitGlobu), pars = c(pars, "lp__"),
                              facet_args = list(labeller = label_parsed)), 
                   mcmc_trace(as.array(fitSp1), pars = c(pars, "lp__"),
                              facet_args = list(labeller = label_parsed)),
                   labels = c("S. globulifera", "S. sp1"), nrow = 2)
```

```{r 2dbh, fig.cap="Markov chains pairs plot after warmup for model dbh only"}
mcmc_pairs(as.array(fitGlobu), pars = c(pars, "lp__"))
mcmc_pairs(as.array(fitSp1), pars = c(pars, "lp__"))
```

```{r Ydbh, fig.cap="Predictions for model dbh only"}
cowplot::plot_grid(
  cbind(data, 
        pred = psych::logistic(apply(as.matrix(fitGlobu, pars = "Theta_pred"), 2, mean))) %>% 
    ggplot(aes(Slope, TWI, col = pred)) + 
    geom_point(aes(alpha = (Species == "globulifera"), col = pred)) +
    scale_alpha_manual(values = c(0,1)), 
  cbind(data, 
        pred = psych::logistic(apply(as.matrix(fitSp1, pars = "Theta_pred"), 2, mean))) %>% 
    ggplot(aes(Slope, TWI)) + 
    geom_point(aes(alpha = (Species == "sp.1"), col = pred)) +
    scale_alpha_manual(values = c(0,1)),
  labels = c("S. globulifera", "S. sp1"), nrow = 2)
```

## Biotic variable

## All
