---
title: "A0: Traits covariation"
date: '`r Sys.Date()`'
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
  bookdown::word_document2: default
  github_document: default
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(parallel)
library(tidyverse)
library(ggfortify)
library(raster)
library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "~/Documents/BIOGECO/PhD/data/Paracou/"
crs <- '+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0' # global crs definition
```

```{r traits}
traits <- googlesheets::gs_title("Measures") %>% 
  googlesheets::gs_read("AllTraits") %>% 
  mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC))
```

```{r trees}
trees <- src_sqlite(file.path(path, "trees/Paracou.sqlite")) %>% 
  tbl("Paracou") %>% 
  filter(idTree %in% traits$idTree) %>% 
  collect() %>% 
  mutate(DBH = CircCorr*pi)
```

```{r env}
# env <- trees %>%
#   dplyr::select(idTree, Xutm, Yutm) %>%
#   unique()
# coordinates(env) <- ~Xutm + Yutm
# proj4string(env) <- '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
# env <- spTransform(env, CRSobj = crs)
# topo <- stack(
#   raster(file.path(path, "topography", "DEM_1m_2015.tif")),
#   raster(file.path(path, "topography", "RelativeElevation_1m.tif")),
#   raster(file.path(path, "topography", "slope_1m.tif")),
#   raster(file.path(path, "topography", "curvature_1m.tif")),
#   raster(file.path(path, "topography", "aspect_1m.tif")),
#   raster(file.path(path, "topography", "TRI_1m.tif")),
#   raster(file.path(path, "topography", "TWI_1m.tif"))
# )
# names(topo) <- c("DEM", "RelativeElevation", "Slope", "Curvature",
#                  "Aspect", "TRI", "TWI")
# topo <- projectRaster(topo, crs = crs)
# env <- data.frame(cbind(env@data, raster::extract(topo, env)))
# rm(topo)
# save(env, file = "./functional_save/env.Rdata")
load("./functional_save/env.Rdata")
load("../../Environment/Competition_save/symphoniaBA.Rdata")
competition <- symphonia
```

# Results

## Traits covariation

```{r PCA, fig.cap='Principal Component Analysis (PCA) of leaf trait values.'}
data.leaf <- traits %>% 
  dplyr::select(-brBT, -brWD, -brBD, -BranchDiameter) %>% 
  na.omit() %>% 
  left_join(dplyr::filter(trees, CensusYear == 2015))
data.all <- traits %>% 
  na.omit() %>% 
  left_join(dplyr::filter(trees, CensusYear == 2015))
pca.leaf <- princomp(~ SLA + LDMC + LT + LA + CC, data = data.leaf, cor = T)
pca.all <- princomp(~ SLA + LDMC + LT + LA + CC + brBT + brBD + brWD, 
                    data = data.all, cor = T)
pca.leaf.plot <- autoplot(pca.leaf, 
         data = data.leaf,
         colour = "Bark", alpha = 0.5, size = "DBH",
         loadings.label.size = 6,
         loadings.label.colour = 'black', loadings.label.vjust = 1.1,
         loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1))
pca.all.plot <- autoplot(pca.all, 
         data = data.all,
         colour = "Bark", alpha = 0.5, size = "DBH",
         loadings.label.size = 6,
         loadings.label.colour = 'black', loadings.label.vjust = 1.1,
         loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1))
g.leaf <- ggExtra::ggMarginal(pca.leaf.plot, groupFill = T)
g.all <- ggExtra::ggMarginal(pca.all.plot, groupFill = T)
```

```{r PCAleaf, fig.cap='Principal Component Analysis (PCA) of leaf trait values.'}
g.leaf
```

```{r PCAall, fig.cap='Principal Component Analysis (PCA) of leaf trait values.'}
g.all
```


## Variance partitionning

```{r VarPart,  fig.cap='Variance partitionning of leaf trait values.'}
traits %>% 
  dplyr::select(Plot, Bark, Dawkins, idTree, Leaf,
                SLA, LDMC, LT, LA, CC) %>% 
  reshape2::melt(id.vars = c("Plot", "Bark", "Dawkins", "idTree", "Leaf"),
                 variable.name = "Trait") %>% 
  group_by(Trait) %>% 
  do(varcomp = as.vector(ape::varcomp(nlme::lme(value ~ Plot, 
                                                random = ~1|Bark/Dawkins/idTree/Leaf, 
                                                data = . , na.action = na.omit) ,1))) %>% 
  broom::tidy(varcomp) %>% 
  rename(Variance = x) %>% 
  mutate(Component = c("Morphotype", "Dawkins", "Tree", "Leaf", "Residual")) %>% 
  ggplot(aes(Trait, Variance, label = round(Variance*100),
             fill = factor(Component, levels = c("Morphotype", "Dawkins", 
                                                 "Tree", "Leaf", "Residual")))) +
  geom_bar(stat = "identity") +
  scale_fill_brewer("Component", palette = "Accent") +
  geom_text(position = position_stack(vjust = 0.5))
```

## Drivers of traits value

## Predictors traits relations

```{r plotVariableTrait}
plotVariableTrait <- function(data, Var) {
  Var <- enquo(Var)
  data %>% 
    group_by(idTree) %>% 
    dplyr::select(!!Var, SLA, LDMC, LA, CC, LT, brBT, brWD, brBD) %>% 
    summarise_all(mean, na.rm = T) %>% 
    reshape2::melt(id.vars = c("idTree", as.character(Var)[2]), 
                   variable.name = "Trait") %>% 
    ggplot(aes(!!Var, value)) +
    geom_point() +
    geom_smooth() +
    facet_wrap(~ Trait, scales = "free")
}
```


```{r dbh}
data <- traits %>%
  mutate(Dawkins = substr(Dawkins, 1,1)) %>% 
  left_join(dplyr::filter(trees, CensusYear == 2015)) %>%
  left_join(env)
plotVariableTrait(data, DBH) + ggtitle("DBH")
plotVariableTrait(data, DEM) + ggtitle("DEM")
plotVariableTrait(data, RelativeElevation) + ggtitle("Relative Elevation")
plotVariableTrait(data, Slope) + ggtitle("Slope")
plotVariableTrait(data, Curvature) + ggtitle("Curvature")
plotVariableTrait(data, Aspect) + ggtitle("Aspect")
plotVariableTrait(data, TRI) + ggtitle("TRI")
plotVariableTrait(data, TWI) + ggtitle("TWI")
plotVariableTrait(data, BranchDiameter) + ggtitle("Branch Diameter")
traits %>% 
  left_join(trees %>% 
  dplyr::filter(CensusYear %in% c(2013, 2015)) %>% 
  arrange(idTree, CensusYear) %>% 
  group_by(idTree) %>% 
  mutate(AGR = (last(DBH) - first(DBH))/2) %>% 
  dplyr::filter(CensusYear == 2015)) %>% 
  plotVariableTrait(AGR) + ggtitle("AGR")
data %>% 
  left_join(competition %>% 
              dplyr::filter(CensusYear == 2015) %>% 
              dplyr::filter(idTree %in% traits$idTree)) %>% 
  plotVariableTrait(BA10) +
  ggtitle("BA10")
```

### Bark Thickness

```{r}
data %>% 
  dplyr::select(brBD, Bark, DBH,
                DEM, RelativeElevation) %>% 
  reshape2::melt(id.var= c("brBD", "Bark", "DBH")) %>% 
  na.omit() %>% 
  ggplot(aes(value, brBD, 
             size = DBH, col = Bark, group = NA)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~ variable, scales = "free")
summary(lm(brBD ~ DEM, data))
summary(lm(brBD ~ RelativeElevation, data))
```

> The bark of a tree serves a protective function, insulating against extremes of temperature, fire, desiccating winds and against herbivory and microbial infections (12). It has been noted that barks of tropical rain‐forest trees are thinner and smoother than those of species in drier habitats (11; 1; 17). 6) observed that monsoon‐forest trees with a thick bark or a bark rich in moisture, such as Eucalyptus spp., have a better chance of withstanding fires. A study in Gabon showed that the barks of woody species in disturbed forests were more frequently associated with toxic chemicals than the woody species characteristic in less disturbed forests (7). These observations suggest that thickness of bark and occurrence of secretions like resins and gums might be correlated with the habitat of a tree species. These attributes could therefore be useful in arriving at a physiognomic–structural classification of vegetation (16). [@Hegde1998]

> Increasing bark thickness contributed significantly to
stiffer stems and greater water storage. Bark density, water content, and mechanics covaried stronglywiththe equivalentwood traits, andto a lesser degree with leaf size, xylemconductivity, and vessel diameter. [@Rosell2014]

## SLA model

### Plot 16 try

```{r}
data <- traits %>%
  mutate(Dawkins = substr(Dawkins, 1,1)) %>% 
  left_join(dplyr::filter(trees, CensusYear == 2015)) %>%
  left_join(env) %>% 
  filter(Plot == 16) %>% 
  group_by(idTree) %>% 
  summarise_if(is.numeric, mean, na.rm = T)
trees <- src_sqlite(file.path(path, "trees/Paracou.sqlite")) %>% 
  tbl("Paracou") %>% 
  dplyr::filter(Plot == 16) %>% 
  dplyr::filter(CensusYear == 2015) %>% 
  collect() %>% 
  mutate(DBH = CircCorr*pi)
```


## Models

$$Trait_i \sim \mathcal{N}(\mu + beta_{dbh}*dbh_i + \beta_{TWI}*TWI_i,\sigma)$$

```{stan envReg, output.var="envReg", echo=T, eval=F}
  data {
    int N ; // # obs
    real Trait[N] ;
    real TWI[N] ;
    real dbh[N] ;
  }
  parameters {
    real mu ;
    real beta_TWI ;
    real beta_dbh ;
    real<lower=0> sigma ;
  }
  model {
    for(n in 1:N)
      Trait[n] ~ normal(mu + beta_dbh*dbh[n] + beta_TWI*TWI[n], sigma) ;
  }
  generated quantities {
    real Traitpred[N] ;
    for(n in 1:N)
      Traitpred[n] = mu + beta_dbh*dbh[n] + beta_TWI*TWI[n] ;
  }
```

```{r regresion}
# data <- traits %>%
#   left_join(dplyr::filter(trees, CensusYear == 2015)) %>%
#   left_join(env)
# fits <- data %>% 
#   dplyr::select(TWI, DBH,
#                 SLA, LDMC, LT, LA, CC, brBT, brBD, brWD) %>% 
#   reshape2::melt(id.vars = c("TWI", "DBH"),
#                  variable.name = "Trait") %>% 
#   filter(!is.na(value)) %>% 
#   group_by(Trait) %>% 
#   do(fit = sampling(envReg, data  = list(N = nrow(.),
#                                          Trait = .$value,
#                                          TWI = .$TWI,
#                                          dbh = .$DBH)))
# save(fits, file = "./functional_save/fits.Rdata")
load("./functional_save/fits.Rdata")
fits %>% 
  broom::tidy(fit, pars = c("mu", "beta_dbh", "beta_TWI", "sigma"), rhat = T) %>% 
  kable()

# lapply(fits$fit, function(fit) mcmc_intervals(as.array(fit, pars = c("mu", "beta_dbh","beta_TWI", "sigma"))))
```

## Redundancy Analysis

### Leaf traits

```{r RDAleaf}
data.leaf <- traits %>%
  mutate(Dawkins = substr(Dawkins, 1,1)) %>% 
  dplyr::select(-Plot, -SubPlot, -TreeFieldNum, -Leaf) %>% 
  group_by(idTree, Morphotype, Bark, Dawkins) %>% 
  summarise_all(mean, na.rm = T) %>% 
    left_join(dplyr::filter(trees, CensusYear == 2015)) %>%
  left_join(env) %>% 
  dplyr::select(-brBT, -brWD, -brBD, -BranchDiameter) %>% 
  na.omit()
library(vegan)
RDA <- rda(data.leaf[c("SLA", "LDMC", "LT", "LA", "CC")],
           data.leaf[c("DBH", "Dawkins", "DEM", "RelativeElevation", "Slope", "Curvature",
          "Aspect", "TRI", "TWI")])
```

```{r rdaPlotLeaf}
rda.plot <- ggplot(cbind(data.frame(summary(RDA)$sites), data.frame(data.leaf)),
                   aes(x = RDA1, y = RDA2)) + 
  geom_point(aes(col = Bark, size = DBH), alpha = 0.5) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  geom_segment(data = summary(RDA)$biplot, 
               aes(x = 0, xend = RDA1*10, y = 0, yend = RDA2*10), 
               color="black", arrow=arrow(length=unit(0.01,"npc"))) +
  geom_text(data = summary(RDA)$biplot, 
            aes(x = RDA1*10, y = RDA2*10, label=rownames(summary(RDA)$biplot),
                hjust = 0.5*(1-sign(RDA1)), vjust = 0.5*(1-sign(RDA2))), 
            color="black", size=4) + 
  geom_segment(data = summary(RDA)$species, 
               aes(x = 0, xend = RDA1, y = 0, yend = RDA2), 
               color="red", arrow=arrow(length=unit(0.01,"npc"))) +
  geom_text(data = summary(RDA)$species, 
            aes(x = RDA1, y = RDA2, label = rownames(summary(RDA)$species),
                hjust=0.5*(1-sign(RDA1)),vjust=0.5*(1-sign(RDA2))), 
            color="red", size=4)
rda.plot <- ggExtra::ggMarginal(rda.plot, groupFill = T)  
rda.plot
```

### All traits

```{r RDAall}
data.all <- traits %>%
  mutate(Dawkins = substr(Dawkins, 1,1)) %>% 
  dplyr::select(-Plot, -SubPlot, -TreeFieldNum, -Leaf) %>% 
  group_by(idTree, Morphotype, Bark, Dawkins) %>% 
  summarise_all(mean, na.rm = T) %>% 
    left_join(dplyr::filter(trees, CensusYear == 2015)) %>%
  left_join(env) %>% 
  na.omit()
RDA <- rda(data.all[c("SLA", "LDMC", "LT", "LA", "CC", "brBT", "brWD", "brBD")],
           data.all[c("DBH", "BranchDiameter", "Dawkins", "DEM", 
                       "RelativeElevation", "Slope", "Curvature",
                       "Aspect", "TRI", "TWI")])
```

```{r rdaPlotall}
rda.plot <- ggplot(cbind(data.frame(summary(RDA)$sites), data.frame(data.all)),
                   aes(x = RDA1, y = RDA2)) + 
  geom_point(aes(col = Bark, size = DBH), alpha = 0.5) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_fixed() +
  geom_segment(data = summary(RDA)$biplot, 
               aes(x = 0, xend = RDA1*10, y = 0, yend = RDA2*10), 
               color="black", arrow=arrow(length=unit(0.01,"npc"))) +
  geom_text(data = summary(RDA)$biplot, 
            aes(x = RDA1*10, y = RDA2*10, label=rownames(summary(RDA)$biplot),
                hjust = 0.5*(1-sign(RDA1)), vjust = 0.5*(1-sign(RDA2))), 
            color="black", size=4) + 
  geom_segment(data = summary(RDA)$species, 
               aes(x = 0, xend = RDA1, y = 0, yend = RDA2), 
               color="red", arrow=arrow(length=unit(0.01,"npc"))) +
  geom_text(data = summary(RDA)$species, 
            aes(x = RDA1, y = RDA2, label = rownames(summary(RDA)$species),
                hjust=0.5*(1-sign(RDA1)),vjust=0.5*(1-sign(RDA2))), 
            color="red", size=4)
rda.plot <- ggExtra::ggMarginal(rda.plot, groupFill = T)  
rda.plot
```
