---
title: "A03: Data exploration"
date: '`r Sys.Date()`'
author: Sylvain Schmitt
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
  bookdown::word_document2: default
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
linestretch: 1.5
#csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
#bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(ggfortify)
library(plotly)
library(kableExtra)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
path <- "../../data/Paracou/"
```

```{r data}
traitsSymphonia <- googlesheets::gs_title("Measures_Symphonia") %>% 
  googlesheets::gs_read("AllTraits") %>% 
  mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC)) %>% 
  mutate(Genus = "Symphonia") %>% 
  rename(Species = Morphotype)
traitsEschweilera <- googlesheets::gs_title("Measures_Eschweilera") %>% 
  googlesheets::gs_read("AllTraits")
traits <- bind_rows(traitsEschweilera, traitsSymphonia) %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) ; rm(traitsEschweilera, traitsSymphonia)
paracou <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% traits$idTree) %>%
  filter(Genus %in% c("Lecythis", "Eschweilera") & Plot %in% c(1, 6, 11, 13:15) & CensusYear == 2017 |
         Genus %in% c("Lecythis", "Eschweilera") & Plot == 16 & CensusYear == 2015 |
         Genus == "Symphonia" & CensusYear == 2015) %>%
  mutate(DBH = CircCorr/pi) %>% 
  collect()
load("./functional_save/env.Rdata")
load("./functional_save/CompetitionMatrix.Rdata")
LBA <- Competition %>% 
  group_by(idTreei) %>% 
  summarise(LBA=((sum((DBH*0.01)^2)*pi)/4)/(20^2*pi*0.0001))%>% 
  rename(idTree="idTreei")
Individuals <- left_join(traits, paracou) %>% 
  left_join(env) %>% 
  left_join(LBA, by="idTree")  %>% 
  group_by(Plot, SubPlot, TreeFieldNum, Genus, Species, SpeciesLong, Bark, Dawkins, DBH, TWI, Curvature, LBA) %>%
  summarise_at(vars("SLA", "LDMC", "LT", "LA", "CC", "brBT", "brBD", "brWD"), mean, na.rm = T)  %>% 
  ungroup() ; rm(traits, paracou, LBA, env, Competition)
```


# Introduction

*What and why...*

# Material & Methods

*Traits variation along environmental descriptors...*

# Results

*Briefly describe traits relations to environment and orient models (below is a chunk example to have a start) ...*

## DBH

```{r DBH, fig.height=12, fig.width=12 }
Individuals %>% 
  #filter(Genus=="Eschweilera" & Species %in% c("coriacea","sagotiana")) %>%
  dplyr::select(DBH, Genus, SpeciesLong, SLA, LDMC, LT, LA, CC, brBT, brBD, brWD) %>%
  reshape2::melt(id.var= c("DBH", "SpeciesLong","Genus"), variable.name = "Trait") %>%
  ggplot(aes(DBH, value, col = SpeciesLong, group = Genus)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ Trait, scales = "free")
```

## LBA

```{r  LBA, fig.height=12, fig.width=12}
Individuals %>% 
  dplyr::select(LBA, SpeciesLong, SLA, LDMC, LT, LA, CC, brBT, brBD, brWD) %>% 
  reshape2::melt(id.var= c("LBA", "SpeciesLong"),
                           variable.name = "Trait") %>%
  ggplot(aes(LBA, value, col = SpeciesLong, group = NA)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ Trait, scales = "free")
```

```{r  LBA2}
d <- Individuals %>% 
  dplyr::select(LBA, SpeciesLong, SLA, LDMC, LT, LA, CC, brBT, brBD, brWD) %>% 
  reshape2::melt(id.var= c("LBA", "SpeciesLong"),
                           variable.name = "Trait") %>%
  group_by(Trait) %>% 
  do(g = ggplot(., aes(LBA, value, col = SpeciesLong, group = NA)) +
       geom_point() +
       geom_smooth() +
       facet_wrap(~ Trait, scales = "free"))
d$g
```

## TWI
```{r TWI, fig.height=12, fig.width=12 }
Individuals %>% 
  dplyr::select(TWI, SpeciesLong, SLA, LDMC, LT, LA, CC, brBT, brBD, brWD) %>% 
  reshape2::melt(id.var= c("TWI", "SpeciesLong"), variable.name = "Trait") %>% 
  ggplot(aes(TWI, value, col = SpeciesLong, group = NA)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ Trait, scales = "free")
```

## Curvature
```{r Curvature, fig.height=12, fig.width=12}
Individuals %>% 
  dplyr::select(Curvature, SpeciesLong, SLA, LDMC, LT, LA, CC, brBT, brBD, brWD) %>% 
  reshape2::melt(id.var= c("Curvature", "SpeciesLong"),
                           variable.name = "Trait") %>% 
  ggplot(aes(Curvature, value, col = SpeciesLong, group = NA)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ Trait, scales = "free")
```

# Discussion

*Discuss and summarise all observed relations towards model building (might several suggestions), including litterature if you can...*

## Conclusion

*Take home message...*

# References

