---
title: "A02: Environmental descriptors selection"
date: '`r Sys.Date()`'
author: Sylvain Schmitt
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
  bookdown::word_document2: default
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(parallel)
library(tidyverse)
library(ggfortify)
library(raster)
#library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
# rstan_options(auto_write = T)
path <- "../../data/Paracou/"
crs <- '+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0' # global crs definition
```

```{r data}
traitsSymphonia <- googlesheets::gs_title("Measures_Symphonia") %>% 
  googlesheets::gs_read("AllTraits") %>% 
  mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC)) %>% 
  mutate(Genus = "Symphonia") %>% 
  rename(Species = Morphotype)
traitsEschweilera <- googlesheets::gs_title("Measures_Eschweilera") %>% 
  googlesheets::gs_read("AllTraits") %>% 
  dplyr::select(-DBH)
traits <- bind_rows(traitsEschweilera, traitsSymphonia) %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) ; rm(traitsEschweilera, traitsSymphonia)
paracou <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% traits$idTree) %>%
  filter(Genus %in% c("Lecythis", "Eschweilera") & Plot %in% c(1, 6, 11, 13:15) & CensusYear == 2017 |
         Genus %in% c("Lecythis", "Eschweilera") & Plot == 16 & CensusYear == 2015 |
         Genus == "Symphonia" & CensusYear == 2015) %>%
  mutate(DBH = CircCorr*pi) %>% 
  collect()
```

```{r env}
# env <- trees %>%
#    dplyr::select(idTree, Xutm, Yutm, DBH, Dawkins) %>%
#    unique()
# coordinates(env) <- ~Xutm + Yutm
# proj4string(env) <- '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
# env <- spTransform(env, CRSobj = crs)
# topo <- stack(
#   raster(file.path(path, "topography", "DEM_1m_2015.tif")),
#   raster(file.path(path, "topography", "RelativeElevation_1m.tif")),
#   raster(file.path(path, "topography", "slope_1m.tif")),
#   raster(file.path(path, "topography", "curvature_1m.tif")),
#   raster(file.path(path, "topography", "aspect_1m.tif")),
#   raster(file.path(path, "topography", "TRI_1m.tif")),
#   raster(file.path(path, "topography", "TWI_1m.tif"))
# )
# names(topo) <- c("DEM", "RelativeElevation", "Slope", "Curvature",
#                  "Aspect", "TRI", "TWI")
# topo <- projectRaster(topo, crs = crs)
# env <- data.frame(cbind(env@data, raster::extract(topo, env)))
# rm(topo)
# save(env, file = "./functional_save/env.Rdata")
load("./functional_save/env.Rdata")
```

# Introduction

This document test for environmental descriptors correlation in order to help select best biotic and abiotic descriptors.
Which descriptors will fit better to the description of the environment?


# Material & Methods
Biotic descriptors available are the following:
* DBH
* Dawkins
* Local basal area
* Competition index
* hauteur de canopée
* distance trouée


Abiotic descriptors available are the following:
* DEM : gathers topographic data from Lidar's campaigns. It enables to represent the topographical forms of the field
* relative elevation : calculate the diference of elevation between a point and the closest creek
* Slope : quantify the value of escarpment of the topography,
* Curvature : quantify the shape of the surface 
* Aspect : quantify cardinal orientation of surfaces
* TRI, or topographic ruggedness index (Riley, et al. (1999)): used to quantify local altitude variations at one point, with adjacent microenvironments.
* TWI, or topographic wetness index: used to quantify the effect of topography on hydrological processes. It is based on the determination of different watersheds, which control the flow of water.

**We need to add biotic environment with local basal area ($BA10$ and $BA20$), Dawkins for light, and DBH for ontogeny !**

# Results

## Ontogeny index

```{r boxplotDawkinsDBH }
env %>%
  dplyr::select(Dawkins,DBH) %>% 
  mutate(Dawkins = substr(Dawkins, 1,1)) %>%
  drop_na(Dawkins) %>% 
  ggplot(aes(x=Dawkins, y=DBH,fill=Dawkins)) + 
  geom_boxplot() + 
  coord_flip()
```
Boxplot between Dawkins and DBH display a strong correlation both variables. With higher DBH, Dawkins index is also higher, showing that light access and ontogeny are strongly linked.
Nevertheless for 3 individuals,  DBH is very outside the usual ranks of individuals of the same Dawkins. 
This corresponds to rare events where a large-diameter tree has been beheaded and started to develop again in a lower stratum, or, when some young individuals take advantage of gaps to reach quickly the upper strata.

## Local basal area

```{r CompetitionMatrix}
# cl <- makeCluster(4)
# clusterExport(cl, list("paracou", "path"))
# Competition <- clusterMap(cl,
#   function(id, plot, census, x, y){
#   library(dplyr)
#   src_sqlite(file.path(path, "trees/Paracou.sqlite")) %>%
#     tbl("Paracou") %>%
#     filter(CensusYear == census) %>%
#     filter(Plot == plot) %>%
#     filter(idTree != id) %>%
#     mutate(DBH = CircCorr*pi) %>%
#     mutate(dij = sqrt((x - Xutm)^2+(y - Yutm)^2)) %>%
#     filter(dij < 20) %>%
#     mutate(idTreej = idTree) %>%
#     mutate(idTreei = id) %>%
#     dplyr::select(idTreei, idTreej, DBH, dij) %>%
#     collect()},
#   id = paracou$idTree,
#   plot = paracou$Plot,
#   x = paracou$Xutm,
#   y = paracou$Yutm,
#   census = paracou$CensusYear,
#   SIMPLIFY = F)
# stopCluster(cl)
# rm(cl)
# Competition <- bind_rows(Competition)
# Competition <- Competition %>%
#   mutate(dij = ifelse(dij < 0.4, 0.4, dij)) # measure precision error troubling NCI fit
# save(Competition, file = "./functional_save/CompetitionMatrix.Rdata")
load("./functional_save/CompetitionMatrix.Rdata")
```

```{r LocalBasalAreaIndex}
Comp <- Competition %>% 
  group_by(idTreei) %>% 
  summarise(LBA=(sum((DBH^2)*pi/4))/(pi*10000*20^2)) %>% 
  rename(idTree="idTreei")
env <- env %>%
  left_join(Comp, by="idTree")
env %>% 
  mutate(Dawkins = substr(Dawkins, 1,1)) %>%
  drop_na(Dawkins) %>% 
  ggplot(aes(x=Dawkins, y=LBA,fill=Dawkins)) +
  geom_boxplot() +
  coord_flip()
```
Boxplot between Dawkins and Local Basal Area do not display any significant correlation between the two indexes. Whatever the Dawkins index is, individuals range almost in the same values, from 0.1 up to 0.5 m/ha.
Competition index and position in forest strata seem to be uncoupled.

## Abiotic descriptors correlation

```{r pairs, fig.cap="Pairs plot"}
env %>% 
  dplyr::select(DEM, RelativeElevation, Slope, Curvature, 
                Aspect, TRI, TWI, DBH, LBA) %>% 
  GGally::ggpairs()
```

```{r corrplot, fig.cap="Correlation plot"}
env %>%
  dplyr::select(DEM, RelativeElevation, Slope, Curvature, 
                Aspect, TRI, TWI, DBH, LBA) %>% 
  na.omit() %>% 
  cor(.) %>% 
  corrplot::corrplot.mixed()
```
The two graphs show the correlations between environmental and biotic descriptors.
The first graph clearly shows that DEM and RelativeElevation, Slope and TRI respectively have a strong positive correlation.
TWI is also negatively correlated to several variables: DEM, RelativeElevation, Slope, TRI. The graphs show a decreasing logarithmic distribution.
Curvature and Aspect have little correlation with other environmental variables, biotic and ontogenetic.
The two biotic and ontogenetic indicators, respectively LBA and LBA, are not very correlated with the other variables.

```{r PCA, fig.cap="Principal compoonent analysis plot"}
pca <- princomp(~ DEM + RelativeElevation + Slope + Curvature + 
                Aspect + TRI + TWI, env, cor = T)
autoplot(pca, 
         colour = "lightgrey",
         loadings.label.size = 6,
         loadings.label.colour = 'black', loadings.label.vjust = 1.1,
         loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1))
```

```{r}
pca <- princomp(~ DEM + RelativeElevation + Slope + Curvature + 
                Aspect + TRI + TWI, env, cor = T)
fviz_pca_var(pca,axes=c(1,2),geom=c("arrow","text"),col.var = "contrib") 
fviz_pca_var(pca,axes=c(1,3),geom=c("arrow","text"), col.var="contrib")
```
Principal component analysis of environmental descriptors is presented on the two main plans: Comp1 / Comp2 & Comp1 / Comp3.
On the first plan, first axis carries 43.7% of the total variance and is mainly explained by increasing TWI. First axis also show the opposition of increasing TWI with RelativeElevation, DEM, Slope and TRI. 
Second PCA axis, 
Curvature
DEM
garder TWI

# Conclusion

**Following conclusion is wrong, to be changed !**

We consequently decided to use 5 weakly ($r < 0.75$) correlated descriptors to model functional traits variation :

* 2 abiotic variables
     * Elevation, representing ...
     * Topographic wetness index, representing ...
* 2 biotic variables
     * The local competition index
     * A disturbance index
* 1 indvidual variable
     * DBH as the ontogenetic descriptor
     
# References

