---
title: "A03 : Model"
date: "December 4, 2018, ECOFOG, Geraldine meeting"
author: Anne Baranger & Sylvain Schmitt
output: 
  revealjs::revealjs_presentation:
    theme: blood
    highlight: pygments
    center: true
    fig_caption: true
    self_contained: false
    reveal_plugins: ["chalkboard"]
    reveal_options:
      slideNumber: true
      previewLinks: true
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 6,
  cache = T, cache.lazy = F)
path <- "../../data/Paracou/"
```


```{r data, eval=T}
traitsSymphonia <- googlesheets::gs_title("Measures_Symphonia") %>% 
  googlesheets::gs_read("AllTraits") %>% 
  mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC)) %>% 
  mutate(Genus = "Symphonia") %>% 
  rename(Species = Morphotype)
traitsEschweilera <- googlesheets::gs_title("Measures_Eschweilera") %>% 
  googlesheets::gs_read("AllTraits")
traits <- bind_rows(traitsEschweilera, traitsSymphonia) %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) ; rm(traitsEschweilera, traitsSymphonia)
paracou <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% traits$idTree) %>%
  filter(Genus %in% c("Lecythis", "Eschweilera") & Plot %in% c(1, 6, 11, 13:15) & CensusYear == 2017 |
         Genus %in% c("Lecythis", "Eschweilera") & Plot == 16 & CensusYear == 2015 |
         Genus == "Symphonia" & CensusYear == 2015) %>%
  mutate(DBH = CircCorr/pi) %>% 
  collect()
load("./functional_save/env.Rdata")
Individuals <- left_join(traits, paracou) %>% 
  left_join(env, by = "idTree", suffix = c("", ".y")) %>% 
  group_by(Plot, SubPlot, TreeFieldNum, Genus, Species, 
           SpeciesLong, Bark, Dawkins, DBH, TWI, Curvature, LBA20, LBA10) %>%
  summarise_at(vars("SLA", "LDMC", "LT", "LA", "CC", 
                    "brBT", "brBD", "brWD"), mean, na.rm = T)  %>%   
  ungroup()
rm(traits, paracou, env)
```

# Introduction

## Introduction

**Graphically explore** variations in leaf traits of individuals tree from *Symphonia globulifera* and *Eschweilera clade Parvifolia* species complexes according to 3 descriptors: (i) tree **ontogeny**, (ii) **biotic** interactions and (iii) **abiotic** environment. From these observations we developed **a generic model** linking **individual phenotype** to its descriptors. The generic model will be inferred later using **Bayesian inference**.

## Individuals phenotype

> 838 trees from Paracou field station

```{r Traits, fig.cap="Functional traits measured, with trait unit, and abbreviation."}
data.frame(
  Traits = c("Specific Leaf Area", "Leaf Dry Matter Content", "Leaf Thickness", "Leaf Area", 
             "Chlorophyll Content", "Branch Bark Thickness" , "Branch Bark Density", 
             "Branch Wood Density "),
  Unit = c("$g.cm^2$","$gÂ·g^{-1}$","$\\mu m$","$cm^2$", "$g.cm^{-2}$","$mm$","$g.cm^{-3}$","$g.cm^{-3}$"),
  Abbreviation = c("SLA", "LDMC","LT", "LA", "CC", "brBT", "brBD", "brWD")) %>% 
  #Formula = c("Area/Dry Mass","Fresh Mass/Dry Mass", "None","None","None","jsp","jsp","jsp")) %>% 
  kable(format = "pandoc", escape = F,
        caption = "Functional traits measured, with trait unit, and abbreviation.") %>%
  kableExtra::kable_styling("striped", full_width = T)
```

## Phenotype descriptors

* **Diameter at breast height** (DBH) was chosen to describe the **ontogeny** of individuals. 
* A **competition index** was used as a descriptor of **biotic environment** effect.
* As a first approach, the **local basal area** (LBA) was chosen as a competition index, but its formula will be discussed in model building. 
* **Topographic wetness index** (TWI) was the **abiotic descriptor** that brought the most relevant information on physical conditions, highlighting water accumulation areas, which is crucial information at local scale when it comes to tropical ecosystems [@ferry2010higher].

## Method

As a first approach to **explore possible model shapes**, measures on **both complexes** were **plotted for each trait** according to environmental data. An indicative local regression was drawn on each graph by applying **loess method to each complex**.

# Ontogenic model

## Scatters

```{r DBH, fig.width=20, fig.height=12, fig.cap="Traits evolution with DBH"}
Individuals %>% 
  filter(!(Genus=="Lecythis")) %>%
  dplyr::select(DBH, Genus, SpeciesLong, SLA, LDMC, LT, LA, CC) %>%
  reshape2::melt(id.var= c("DBH", "SpeciesLong","Genus"), variable.name = "Trait") %>%
  ggplot(aes(DBH, value, col = SpeciesLong, group = Genus)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ Trait, scales = "free")
```

## Data exploration

* DBH, depict here both light access and ontogeny effect
* Use $\frac{1}{SLA}$ and $\frac{1}{LA}$
* Integrate a null effect of ontogeny
* Michaelis-menten model because of the saturation
* LogNormal model because of a progressive deceleration
* Linear model because of constant or null evolution
* Taxonomic levels as random nested effect

## Model

$$T_i \sim \mathcal{N}(\cfrac{\alpha_{DBH} . DBH_i}{\beta_{DBH} + DBH_i},\sigma_{DBH})$$
$$(\alpha_{DBH},\beta_{DBH},\sigma_{DBH}) \sim \Gamma^{3}(- \infty, + \infty)$$


# Competition model

## Scatters

```{r LBA, fig.height=12, fig.width=20, fig.cap="Traits evolution, with LBA"}
Individuals %>% 
  filter(!(Genus=="Lecythis")) %>%
  dplyr::select(LBA10, SpeciesLong, Genus, SLA, LDMC, LT, LA, CC) %>% 
  reshape2::melt(id.var= c("LBA10", "SpeciesLong", "Genus"),
                           variable.name = "Trait") %>%
  ggplot(aes(LBA10, value, col = SpeciesLong, group = Genus)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ Trait, scales = "free")
```

## Data exploration

* Integrate a null effect of competition
* Linear form
* Taxonomic levels as random nested effect

## Model

$$T_i \sim \mathcal{N}(\alpha_{comp} + \beta_{comp}. \sum_{j~|~\delta_{i,j}<\delta_{max}}^{J_i} DBH_j^{\beta_{NCI}}.e^{-\alpha_{NCI}.\delta_{i,j}}, \sigma_{comp})$$
$$(\alpha_{comp}, \beta_{comp}, \beta_{NCI}) \sim \mathcal{N}^{3}(0, + \infty)$$
$$(\alpha_{NCI}, \sigma_{comp}) \sim \Gamma(- \infty, + \infty)$$

# Abiotic model

## Scatters

```{r TWI, fig.height=12, fig.width=20, fig.cap="Traits evolution with TWI"}
Individuals %>% 
  filter(!(Genus=="Lecythis")) %>%
  dplyr::select(TWI, SpeciesLong, Genus, SLA, LDMC, LT, LA, CC) %>% 
  reshape2::melt(id.var= c("TWI", "SpeciesLong","Genus"), variable.name = "Trait") %>% 
  ggplot(aes(TWI, value, col = SpeciesLong, group = Genus)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ Trait, scales = "free")
```

## Data exploration

* Integrate a null effect of abiotic environment
* Linear form
* Taxonomic levels as random nested effect

## Model

$$T_i \sim \mathcal{N}(\alpha_{TWI} + \beta_{TWI}. TWI_i ,\sigma_{TWI})$$
$$(\alpha_{TWI}, \sigma_{comp}) \sim \Gamma^{2}(- \infty, + \infty)$$
$$(\beta_{TWI}) \sim \mathcal{N}(0, + \infty)$$

# Full model

After defining each submodel, we tried to gather them all in a full model including ontogeny, biotic and abiotic effects to explain individual phenotype.

## Additive

$$T_i \sim \mathcal{N}(\frac{\alpha_{DBH}.DBH_i}{\beta_{DBH} + DBH_i} + \beta_{TWI}.TWI_i + \\ \beta_{comp}.\sum_{j=1}^{J} DBH_j^2 . e^{-\alpha_{NCI}.\delta_{i,j}}, \sigma)$$
$$(\alpha_{DBH},\beta_{DBH},\alpha_{NCI},\sigma) \sim \Gamma^{4}(- \infty, + \infty)$$
$$(\beta_{TWI}, \beta_{comp}) \sim \mathcal{N}(0, + \infty)$$

## Hierarchical

$$T_i \sim \mathcal{N}(\frac{\alpha.DBH_i}{\beta_{DBH} + DBH_i},\sigma)$$
$$\alpha \sim \mathcal{N}(\alpha_{DBH} + \beta_{TWI}.TWI_i  +  \beta_{comp}.\sum_{j=1}^{J} DBH_j^2 . e^{-\alpha_{NCI}.\delta_{i,j}}, \sigma_{DBH})$$
$$(\alpha_{DBH}, \beta_{DBH}, \alpha_{NCI}, \sigma_{DBH}, \alpha, \sigma) \sim \Gamma^{6}(- \infty, + \infty)$$
$$(\beta_{TWI}, \beta_{comp}) \sim \mathcal{N}^2(0, + \infty)$$

# Random nested effects

## Why

* Individuals displayed different trends depending on complex and species
* Taxonomic levels as random nested effects:
    1. variability of **individuals between complexes** ($C$ levels)
    1. variability of individuals **within a complex and between species** ($S_c$ level)
    1. variability of individuals **within a species** ($I_{s}$ level)

## Model

$$T_{c,s,i} \sim \mathcal{N}(\frac{{\alpha_{DBH}}_{c,s,i}.DBH_i}{{\beta_{DBH}}_{c,s,i} + DBH_i} + {\beta_{TWI}}_{c,s,i}.TWI_i + \\{\beta_{Comp}}_{c,s,i}.\sum_{j=1}^{J} DBH_j^{2} . e^{-{\alpha_{NCI}}_{c,s,i}.\delta_{i,j}}, \sigma)$$
$$|~\forall \beta ~parameters, $$
$$\beta_{c,s,i} \sim \mathcal{N}(\beta_{c,s}~,\sigma_{individual})$$
$$\beta_{c,s} \sim \mathcal{N}(\beta_s,\sigma_{species})$$ 
$$\beta_{c} \sim \mathcal{N}(\beta,\sigma_{complex})$$

## Parameters choice

We will have to investigate on whether it is relevant to apply a random nested effect on each parameter. Because $\beta_{DBH}$ is the DBH for which the trait account for half of its saturation value, it is conditional to  ${\alpha_{DBH}}_{c,s,i}$, which already integrate random nested effects. Consequently, nested random effect could be removed of $\beta_{DBH}$, and similarly for $\alpha_{NCI}$.

# Inference strategy

## Tricks

* Scale and/or center descriptors ($DBH_i$, $TWI$, $DBH_j$, $\delta_{i,j}$) 
* Check for parameters relation, especially suspected one between $\beta_{Comp}$ and  $\alpha_{NCI}$ (non identifiable when $\alpha_{NCI} \to \infty$), and decorrelate with intermediate parameter inference (e.g. $\beta_{Comp}'=f(\beta_{Comp}, \alpha_{NCI})$)
* Use a transformed parameter $\beta_{DBH}' = e^{-\beta_{DBH}}$ for $\beta_{DBH}$ inference to help $\beta_{DBH}$ explore a null effect of ontogeny

## Data - Traits

1. Reduced dataset for only one trait (e.g. 100 observations of SLA)
1. Full dataset for only one trait (e.g. 838 observations of SLA)
1. Full dataset for two orthogonal traits (e.g. 838 observations of SLA and LT)
1. Full dataset for all traits

## Models

1. Each sub-model (ontogeny, abiotic, biotic)
    1. Without taxonomic levels (each possible form)
    1. With taxonomic levels (added one-by-one)
1. The full model
    1. Additive (total or one-by-one if bug)
    1. Hierarchical (total or one-by-one if bug)
    1. Add taxonomic levels

# Conclusion

## Likelihood

$$T_{c,s,i} \sim \mathcal{N}(\frac{{\alpha_{DBH}}_{c,s,i}.DBH_i}{{\beta_{DBH}}_{c,s,i} + DBH_i} + {\beta_{TWI}}_{c,s,i}.TWI_i + \\{\beta_{Comp}}_{c,s,i}.\sum_{j=1}^{J} DBH_j^{2} . e^{-{\alpha_{NCI}}_{c,s,i}.\delta_{i,j}}, \sigma)$$

## Individual Random Effect

$$\begin{bmatrix}
           {\alpha_{DBH}}_{c,s,i} \\
           {\beta_{DBH}}_{c,s,i} \\
           {\beta_{TWI}}_{c,s,i} \\
           {\beta_{Comp}}_{c,s,i} \\
           {\alpha_{NCI}}_{c,s,i}
  \end{bmatrix} \sim \mathcal{N}^5(
  \begin{bmatrix}
           {\alpha_{DBH}}_{c,s} \\
           {\beta_{DBH}}_{c,s} \\
           {\beta_{TWI}}_{c,s} \\
           {\beta_{Comp}}_{c,s} \\
           {\alpha_{NCI}}_{c,s}
  \end{bmatrix} ,
  \begin{bmatrix}
           {\sigma_{DBH}}_{individual} \\
           {\sigma_{DBH2}}_{individual} \\
           {\sigma_{TWI}}_{individual} \\
           {\sigma_{Comp}}_{individual} \\
           {\sigma_{NCI}}_{individual}
  \end{bmatrix})$$
  
## Species Random Effect

$$\begin{bmatrix}
           {\alpha_{DBH}}_{c,s} \\
           {\beta_{DBH}}_{c,s} \\
           {\beta_{TWI}}_{c,s} \\
           {\beta_{Comp}}_{c,s} \\
           {\alpha_{NCI}}_{c,s}
  \end{bmatrix} \sim \mathcal{N}^5(
  \begin{bmatrix}
           {\alpha_{DBH}}_{c} \\
           {\beta_{DBH}}_{c} \\
           {\beta_{TWI}}_{c} \\
           {\beta_{Comp}}_{c} \\
           {\alpha_{NCI}}_{c}
  \end{bmatrix} ,
  \begin{bmatrix}
           {\sigma_{DBH}}_{species} \\
           {\sigma_{DBH2}}_{species} \\
           {\sigma_{TWI}}_{species} \\
           {\sigma_{Comp}}_{species} \\
           {\sigma_{NCI}}_{species}
  \end{bmatrix})$$
  
## Complex Random Effect

$$\begin{bmatrix}
           {\alpha_{DBH}}_c \\
           {\beta_{DBH}}_c \\
           {\beta_{TWI}}_c \\
           {\beta_{Comp}}_c \\
           {\alpha_{NCI}}_c
  \end{bmatrix} \sim \mathcal{N}^5(
  \begin{bmatrix}
           {\alpha_{DBH}} \\
           {\beta_{DBH}} \\
           {\beta_{TWI}} \\
           {\beta_{Comp}} \\
           {\alpha_{NCI}}
  \end{bmatrix} ,
  \begin{bmatrix}
           {\sigma_{DBH}}_{complex} \\
           {\sigma_{DBH2}}_{complex} \\
           {\sigma_{TWI}}_{complex} \\
           {\sigma_{Comp}}_{complex} \\
           {\sigma_{NCI}}_{complex}
  \end{bmatrix})$$

## Priors

$$(\alpha_{DBH}, \beta_{DBH}, \alpha_{NCI}, \sigma) \sim \Gamma^{4}(- \infty, + \infty) \\
(\beta_{TWI}, \beta_{comp}) \sim \mathcal{N}^2(0, + \infty) \\
({\sigma_{DBH}}_{individual}, {\sigma_{DBH2}}_{individual}, {\sigma_{TWI}}_{individual},\\ {\sigma_{Comp}}_{individual}, {\sigma_{NCI}}_{individual}) \sim \Gamma^{5}(- \infty, + \infty) \\
  ({\sigma_{DBH}}_{species}, {\sigma_{DBH2}}_{species}, {\sigma_{TWI}}_{species},\\ {\sigma_{Comp}}_{species}, {\sigma_{NCI}}_{species}) \sim \Gamma^{5}(- \infty, + \infty) \\
  ({\sigma_{DBH}}_{complex}, {\sigma_{DBH2}}_{complex}, {\sigma_{TWI}}_{complex},\\ {\sigma_{Comp}}_{complex}, {\sigma_{NCI}}_{complex}) \sim \Gamma^{5}(- \infty, + \infty)$$

## References
