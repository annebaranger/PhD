---
title: "A01: Traits covariation"
date: '`r Sys.Date()`'
author: Sylvain Schmitt
output:
  bookdown::html_document2:
    number_sections: false
    toc: true
    toc_float: yes
  bookdown::word_document2: default
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(ggfortify)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
path <- "../../data/Paracou/"
```

```{r data}
traitsSymphonia <- googlesheets::gs_title("Measures_Symphonia") %>% 
  googlesheets::gs_read("AllTraits") %>% 
  mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC)) %>% 
  mutate(Genus = "Symphonia") %>% 
  rename(Species = Morphotype)
traitsEschweilera <- googlesheets::gs_title("Measures_Eschweilera") %>% 
  googlesheets::gs_read("AllTraits") %>% 
  dplyr::select(-DBH)
traits <- bind_rows(traitsEschweilera, traitsSymphonia) %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) ; rm(traitsEschweilera, traitsSymphonia)
paracou <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% traits$idTree) %>%
  filter(Genus %in% c("Lecythis", "Eschweilera") & Plot %in% c(1, 6, 11, 13:15) & CensusYear == 2017 |
         Genus %in% c("Lecythis", "Eschweilera") & Plot == 16 & CensusYear == 2015 |
         Genus == "Symphonia" & CensusYear == 2015) %>%
  mutate(DBH = CircCorr*pi) %>% 
  collect()
data <- left_join(traits, paracou) ; rm(traits, paracou)
data <- data %>% # outliers removal
  filter(Plot != 14 & SubPlot != 1 & TreeFieldNum != 760) # rejection individual
data <- list(
  leaf = data %>% 
  dplyr::select(Plot, SubPlot, TreeFieldNum, Leaf,
                Genus, Species, SpeciesLong, Bark, Dawkins, DBH,
                SLA, LDMC, LT, LA, CC) %>% 
  group_by(Plot, SubPlot, TreeFieldNum,
           Genus, Species, SpeciesLong, Bark, Dawkins, DBH) %>% 
  summarise_at(vars("SLA", "LDMC", "LT", "LA", "CC"), mean, na.rm = T) %>% 
  ungroup() %>% 
  drop_na(SLA, LDMC, LT, LA, CC),
  wood = data %>% 
    dplyr::select(Plot, SubPlot, TreeFieldNum, Leaf,
                Genus, Species, SpeciesLong, Bark, Dawkins, DBH,
                SLA, LDMC, LT, LA, CC, brBT, brBD, brWD) %>% 
  group_by(Plot, SubPlot, TreeFieldNum,
           Genus, Species, SpeciesLong, Bark, Dawkins, DBH) %>% 
  summarise_at(vars("SLA", "LDMC", "LT", "LA", "CC", "brBT", "brBD", "brWD"), 
               mean, na.rm = T) %>% 
  ungroup() %>% 
  drop_na(SLA, LDMC, LT, LA, CC, brBT, brBD, brWD)
)
```

# Introduction

*What and why...*

# Material & Methods

*Traits covariation by PCA...*

# Results

*Describe all observed relations in each case (\@ref(fig:PCAleafComplexes) to refer to a figure)...*

## Leaf traits

### Between complexes

```{r PCAleafComplexes, fig.cap='Principal Component Analysis (PCA) of leaf trait  between complexes.'}
data$leaf %>% 
  autoplot(princomp(~ SLA + LDMC + LT + LA + CC, data = ., cor = T), 
           data = .,
           colour = "Genus", alpha = 0.5, size = "DBH",
           loadings.label.size = 6,
           loadings.label.colour = 'black', loadings.label.vjust = 1.1,
           loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1))
# g <- ggExtra::ggMarginal(g, groupFill = T)
```

### Within complexes

```{r PCAleafSymphonia, fig.cap='Principal Component Analysis (PCA) of leaf trait wihtin Symphonia complex.'}
data$leaf %>% 
  filter(Genus == "Symphonia") %>% 
  autoplot(princomp(~ SLA + LDMC + LT + LA + CC, data = ., cor = T), 
           data = .,
           colour = "SpeciesLong", alpha = 0.5, size = "DBH",
           loadings.label.size = 6,
           loadings.label.colour = 'black', loadings.label.vjust = 1.1,
           loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1))
```

```{r PCAleafEschweilera, fig.cap='Principal Component Analysis (PCA) of leaf trait wihtin Eschweilera complex.'}
data$leaf %>% 
  filter(Genus != "Symphonia") %>% 
  autoplot(princomp(~ SLA + LDMC + LT + LA + CC, data = ., cor = T), 
           data = .,
           colour = "SpeciesLong", alpha = 0.5, size = "DBH",
           loadings.label.size = 6,
           loadings.label.colour = 'black', loadings.label.vjust = 1.1,
           loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted")
```

## Within *Symphonia* species

```{r PCAleafSymphoniaSpecies, fig.cap='Principal Component Analysis (PCA) of leaf trait wihtin Symphonia species.'}
pcas <- data$leaf %>% 
  filter(Genus == "Symphonia") %>% 
  filter(Species != "Indet.") %>% 
  mutate(Dawkins = gsub('([[:alpha:]])', "", Dawkins)) %>% 
  group_by(SpeciesLong) %>% 
  do(pcas = autoplot(princomp(~ SLA + LDMC + LT + LA + CC, data = ., cor = T), 
           data = .,
           colour = "Dawkins", alpha = 0.5, size = "DBH",
           loadings.label.size = 6,
           loadings.label.colour = 'black', loadings.label.vjust = 1.1,
           loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted"))
cowplot::plot_grid(plotlist = pcas$pcas, labels = pcas$SpeciesLong)
```

## Within *Eschweilera* species

```{r PCAleafEschweileraSpecies, fig.cap='Principal Component Analysis (PCA) of leaf trait wihtin Eschweilera species.'}
pcas <- data$leaf %>% 
  filter(Genus != "Symphonia") %>% 
  mutate(Dawkins = gsub('([[:alpha:]])', "", Dawkins)) %>% 
  group_by(SpeciesLong) %>% 
  filter(n() > 10) %>% 
  do(pcas = autoplot(princomp(~ SLA + LDMC + LT + LA + CC, data = ., cor = T), 
           data = .,
           colour = "Dawkins", alpha = 0.5, size = "DBH",
           loadings.label.size = 6,
           loadings.label.colour = 'black', loadings.label.vjust = 1.1,
           loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted"))
cowplot::plot_grid(plotlist = pcas$pcas, labels = pcas$SpeciesLong)
```

## Wood traits

### Within complexes

```{r PCAwoodSymphonia, fig.cap='Principal Component Analysis (PCA) of wood trait wihtin Symphonia complex.'}
data$wood %>% 
  filter(Genus == "Symphonia") %>% 
  autoplot(princomp(~ SLA + LDMC + LT + LA + CC + brBT + brBD + brWD, data = ., cor = T), 
           data = .,
           colour = "SpeciesLong", alpha = 0.5, size = "DBH",
           loadings.label.size = 6,
           loadings.label.colour = 'black', loadings.label.vjust = 1.1,
           loadings = T, loadings.label = T, loadings.colour = 'black') +
  coord_equal() +
  geom_hline(aes(yintercept = 0), col = 'black', linetype = "dotted") +
  geom_vline(aes(xintercept = 0), col = 'black', linetype = "dotted") +
  theme(legend.position = c(1, 1), 
        legend.justification = c(1, 1))
```

# Discussion

*Discuss and summarise all observed relations in regard of litterature...*

## Conclusion

*Take home message...*

# References
